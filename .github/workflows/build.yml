name: Build APK - Dictado Profesional v1.0.21

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.1'
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Build APK
      run: flutter build apk --release --build-name="MICROFONO-SEPARADO-v1.0.20" --build-number=20

    - name: Rename APK
      run: |
        mkdir -p apk_outputs
        cp build/app/outputs/flutter-apk/app-release.apk apk_outputs/Diario-DICTADO-PROFESIONAL-v1.0.21.apk

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Diario-DICTADO-PROFESIONAL-v1.0.21
        path: apk_outputs/Diario-DICTADO-PROFESIONAL-v1.0.21.apk
        retention-days: 30

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.21-dictado-profesional
        name: Diario Personal - Sistema Dictado Profesional v1.0.21
        body: |
          🎤 **SISTEMA DE DICTADO PROFESIONAL** - ¡SIN INTERRUPCIONES!
          
          ## ✨ **MEJORAS PRINCIPALES:**
          
          ### 🎯 **Dictado Completamente Mejorado:**
          - 🟢 **Botón INICIAR** → Activa micrófono y escucha SIN LÍMITES
          - 🔴 **Botón DETENER** → Para el dictado solo cuando TÚ quieras
          - ⏰ **ESCUCHA CONTINUA** hasta 10 minutos sin interrupciones
          - 🚫 **NO se para automáticamente** por silencio
          - 🔄 **Reinicio inteligente** cuando se necesita
          
          ### 🧠 **Inteligencia de Texto:**
          - 🔤 **Capitalización automática** después de puntos
          - 📏 **Espaciado inteligente** entre palabras
          - 🎯 **Procesamiento mejorado** de resultados finales/parciales
          - 📝 **Sin duplicación de texto**
          - ✅ **Mejor precisión** en reconocimiento
          
          ### 🔧 **Correcciones Técnicas:**
          - ⚡ **Basado en dictáfono profesional** comprobado
          - 🛠️ **Configuración optimizada** de SpeechToText
          - 📱 **Mejor manejo de errores** de micrófono
          - 🔄 **Estados de dictado** más estables
          - 🎪 **Confirmaciones visuales** de acciones
          
          ### 🖼️ **Interfaz Mejorada:**
          - 🟢 Botón verde para iniciar dictado
          - 🔴 Botón rojo para detener dictado
          - 👆 Botones más claros y fáciles de usar
          - 🎯 Indicadores visuales del estado del micrófono
          
          ### 🎨 **FUNCIONES COMPLETAS:**
          - 🎤 **Dictado profesional** sin interrupciones (MEJORADO)
          - 🗑️ **Eliminación perfecta** de entradas
          - 📁 **Importar/exportar** con cifrado
          - 🔐 **Sistema de contraseñas** seguro
          - 🔍 **Zoom interactivo** en pantalla
          - ✏️ **Edición completa** de entradas
          - 🎨 **9 TEMAS** (1 claro + 8 oscuros)
          
          ### 📱 **INSTALACIÓN:**
          Descarga `Diario-DICTADO-PROFESIONAL-v1.0.21.apk` e instálala.
          
          **¡Dictado de voz perfeccionado al máximo!** 🎤✨
        files: |
          apk_outputs/Diario-DICTADO-PROFESIONAL-v1.0.21.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}